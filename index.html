<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบฐานข้อมูลหมู่บ้านนักเรียน</title>
    
    <!-- Google Fonts: Prompt -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Custom styles */
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f7f3ff;
        }
        .main-gradient-bg {
            background-image: linear-gradient(to bottom right, #f3e8ff, #fef9c3, #fffbeb);
        }
        .form-container, .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(167, 139, 250, 0.15);
        }
        .form-input, .form-select {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #a78bfa;
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
        }
        .btn-action {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(0, 0, 0, 0.1);
        }
        .btn-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px 0 rgba(0, 0, 0, 0.15);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .stat-card {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .stat-card h3 { color: #581c87; }
        .stat-card p { color: #a855f7; }
        .photo-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid #ddd;
        }
        .detail-photo {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 1rem;
            border: 4px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="main-gradient-bg">

    <div class="container mx-auto p-4 md:p-8 min-h-screen">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <img src="https://i.postimg.cc/fbhJ98Xj/2.png" alt="School Logo" class="mx-auto mb-4" style="width: 150px;">
            <h1 class="text-2xl md:text-3xl font-bold text-purple-800">ระบบฐานข้อมูลหมู่บ้านนักเรียน</h1>
            <h2 class="text-lg md:text-xl font-normal text-gray-700">โรงเรียนนาดูนประชาสรรพ์ ปีการศึกษา 2568</h2>
        </header>

        <main class="max-w-7xl mx-auto">
            <!-- Action Buttons -->
            <div class="flex justify-center gap-4 md:gap-6 mb-8">
                <button id="showFormButton" class="btn-action flex items-center gap-3 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-full text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                    เพิ่มข้อมูลนักเรียน
                </button>
                <button id="adminButton" class="btn-action flex items-center gap-3 bg-amber-400 hover:bg-amber-500 text-purple-900 font-bold py-3 px-6 rounded-full text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                    สำหรับผู้ดูแลระบบ
                </button>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="card p-6 rounded-2xl">
                <!-- Dashboard content will be injected here -->
            </div>

            <!-- New Status Dashboard Section -->
            <div id="status-dashboard-section" class="card p-6 rounded-2xl mt-6 hidden">
                <!-- Status dashboard content will be injected here -->
            </div>

            <!-- Dashboard Table Container -->
            <div id="dashboard-table-container" class="hidden mt-6">
                <!-- Filtered table will be injected here -->
            </div>

            <!-- Admin Section (Hidden by default) -->
            <div id="admin-section" class="hidden mt-10">
                <!-- Admin controls and table will be injected here -->
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="text-center mt-12 pb-8 text-sm text-gray-600">
            <p>&copy; 2025 งานทะเบียน-วัดผล โรงเรียนนาดูนประชาสรรพ์</p>
            <p>พัฒนาระบบโดย : ครูชัยวัฒน์ สุบัติคำ ครู คศ.3 กลุ่มสาระการเรียนรู้คณิตศาสตร์</p>
        </footer>
    </div>
    
    <!-- Modals (Initially empty, populated by templates) -->
    <div id="formModal" class="modal"></div>
    <div id="adminModal" class="modal"></div>
    <div id="adminEditModal" class="modal"></div>
    <div id="studentDetailModal" class="modal"></div>


    <!-- Templates for injection -->
    <template id="dashboardTemplate">
        <h3 class="text-xl font-semibold text-center text-purple-800 mb-6">ภาพรวมข้อมูลนักเรียนทั้งหมด</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div class="stat-card bg-purple-50 p-4 rounded-xl" data-filter-type="gender" data-filter-value="ชาย"><h3 class="font-semibold text-md">นักเรียนชาย</h3><p id="male-count" class="text-3xl font-bold">0</p></div>
            <div class="stat-card bg-pink-50 p-4 rounded-xl" data-filter-type="gender" data-filter-value="หญิง"><h3 class="font-semibold text-md">นักเรียนหญิง</h3><p id="female-count" class="text-3xl font-bold">0</p></div>
            <div class="stat-card bg-green-50 p-4 rounded-xl" data-filter-type="level" data-filter-value="junior"><h3 class="font-semibold text-md">มัธยมต้น</h3><p id="junior-high-count" class="text-3xl font-bold">0</p></div>
            <div class="stat-card bg-sky-50 p-4 rounded-xl" data-filter-type="level" data-filter-value="senior"><h3 class="font-semibold text-md">มัธยมปลาย</h3><p id="senior-high-count" class="text-3xl font-bold">0</p></div>
        </div>
        <div class="grid grid-cols-3 md:grid-cols-6 gap-4 mt-4 text-center">
            <div class="stat-card bg-gray-50 p-4 rounded-xl" data-filter-type="class" data-filter-value="ม.1"><h3 class="font-semibold">ม.1</h3><p id="m1-count" class="text-2xl font-bold">0</p></div>
            <div class="stat-card bg-gray-50 p-4 rounded-xl" data-filter-type="class" data-filter-value="ม.2"><h3 class="font-semibold">ม.2</h3><p id="m2-count" class="text-2xl font-bold">0</p></div>
            <div class="stat-card bg-gray-50 p-4 rounded-xl" data-filter-type="class" data-filter-value="ม.3"><h3 class="font-semibold">ม.3</h3><p id="m3-count" class="text-2xl font-bold">0</p></div>
            <div class="stat-card bg-gray-50 p-4 rounded-xl" data-filter-type="class" data-filter-value="ม.4"><h3 class="font-semibold">ม.4</h3><p id="m4-count" class="text-2xl font-bold">0</p></div>
            <div class="stat-card bg-gray-50 p-4 rounded-xl" data-filter-type="class" data-filter-value="ม.5"><h3 class="font-semibold">ม.5</h3><p id="m5-count" class="text-2xl font-bold">0</p></div>
            <div class="stat-card bg-gray-50 p-4 rounded-xl" data-filter-type="class" data-filter-value="ม.6"><h3 class="font-semibold">ม.6</h3><p id="m6-count" class="text-2xl font-bold">0</p></div>
        </div>
    </template>
    
    <template id="formModalTemplate">
        <div class="form-container w-full max-w-5xl mx-auto my-8 p-6 md:p-8 rounded-2xl relative">
            <button id="closeFormModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>
            <h3 id="form-title" class="text-xl font-semibold text-center text-purple-800 mb-6">เพิ่มข้อมูลนักเรียน</h3>
            <form id="studentForm">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="student_id" class="block mb-2 font-medium">เลขประจำตัวนักเรียน</label>
                        <input type="number" id="student_id" name="student_id" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="prefix" class="block mb-2 font-medium">คำนำหน้าชื่อ</label>
                        <select id="prefix" name="prefix" class="w-full p-3 rounded-lg form-select" required></select>
                    </div>
                    <div>
                        <label for="firstname" class="block mb-2 font-medium">ชื่อ</label>
                        <input type="text" id="firstname" name="firstname" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="lastname" class="block mb-2 font-medium">นามสกุล</label>
                        <input type="text" id="lastname" name="lastname" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="nickname" class="block mb-2 font-medium">ชื่อเล่น</label>
                        <input type="text" id="nickname" name="nickname" class="w-full p-3 rounded-lg form-input">
                    </div>
                    <div>
                        <label for="class" class="block mb-2 font-medium">ชั้นเรียน</label>
                        <select id="class" name="class" class="w-full p-3 rounded-lg form-select" required></select>
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">เพศ</label>
                        <div class="flex items-center space-x-4 mt-2 p-2">
                            <label><input type="radio" name="gender" value="ชาย" class="mr-2" required> ชาย</label>
                            <label><input type="radio" name="gender" value="หญิง" class="mr-2"> หญิง</label>
                        </div>
                    </div>
                    <div>
                        <label for="weight" class="block mb-2 font-medium">น้ำหนัก (กก.)</label>
                        <input type="number" id="weight" name="weight" class="w-full p-3 rounded-lg form-input" step="0.1">
                    </div>
                    <div>
                        <label for="height" class="block mb-2 font-medium">ส่วนสูง (ซม.)</label>
                        <input type="number" id="height" name="height" class="w-full p-3 rounded-lg form-input">
                    </div>
                    <div>
                        <label for="village" class="block mb-2 font-medium">หมู่บ้าน</label>
                        <input type="text" id="village" name="village" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                         <label for="subdistrict" class="block mb-2 font-medium">ตำบล</label>
                        <input type="text" id="subdistrict" name="subdistrict" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="district" class="block mb-2 font-medium">อำเภอ</label>
                        <input type="text" id="district" name="district" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                </div>
                <div class="mt-8 flex justify-center gap-4">
                    <button type="submit" id="submitButton" class="btn-action bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-8 rounded-full text-lg">บันทึกข้อมูล</button>
                    <button type="button" id="clearButton" class="btn-action bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-8 rounded-full text-lg">ล้างข้อมูล</button>
                </div>
            </form>
        </div>
    </template>
    
    <template id="adminModalTemplate">
        <div class="card w-full max-w-sm mx-auto my-auto p-8 rounded-2xl text-center">
            <h3 class="text-xl font-semibold mb-4 text-purple-800">กรุณาใส่รหัสผ่านผู้ดูแล</h3>
            <input type="password" id="adminPasswordInput" maxlength="50" class="w-full p-3 rounded-lg form-input mb-4" placeholder="รหัสผ่าน">
            <div class="flex justify-center gap-4">
              <button id="submitPassword" class="flex-grow bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition">เข้าสู่ระบบ</button>
              <button id="closeAdminModal" class="flex-grow bg-gray-300 text-black px-6 py-2 rounded-lg hover:bg-gray-400 transition">ยกเลิก</button>
            </div>
        </div>
    </template>

    <template id="adminEditModalTemplate">
        <div class="form-container w-full max-w-5xl mx-auto my-8 p-6 md:p-8 rounded-2xl relative">
            <button id="closeAdminEditModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>
            <h3 class="text-xl font-semibold text-center text-purple-800 mb-6">แก้ไขข้อมูลนักเรียน (Admin)</h3>
            <form id="adminEditForm">
                <input type="hidden" id="adminEditRow" name="row">
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="admin_student_id" class="block mb-2 font-medium">เลขประจำตัว</label>
                        <input type="number" id="admin_student_id" name="student_id" class="w-full p-3 rounded-lg form-input" readonly>
                    </div>
                    <div>
                        <label for="admin_prefix" class="block mb-2 font-medium">คำนำหน้าชื่อ</label>
                        <select id="admin_prefix" name="prefix" class="w-full p-3 rounded-lg form-select" required></select>
                    </div>
                    <div>
                        <label for="admin_firstname" class="block mb-2 font-medium">ชื่อ</label>
                        <input type="text" id="admin_firstname" name="firstname" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="admin_lastname" class="block mb-2 font-medium">นามสกุล</label>
                        <input type="text" id="admin_lastname" name="lastname" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="admin_nickname" class="block mb-2 font-medium">ชื่อเล่น</label>
                        <input type="text" id="admin_nickname" name="nickname" class="w-full p-3 rounded-lg form-input">
                    </div>
                    <div>
                        <label for="admin_class" class="block mb-2 font-medium">ชั้นเรียน</label>
                        <select id="admin_class" name="class" class="w-full p-3 rounded-lg form-select" required></select>
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">เพศ</label>
                        <div class="flex items-center space-x-4 mt-2 p-2" id="admin_gender">
                            <label><input type="radio" name="gender" value="ชาย" class="mr-2">ชาย</label>
                            <label><input type="radio" name="gender" value="หญิง" class="mr-2">หญิง</label>
                        </div>
                    </div>
                    <div>
                        <label for="admin_weight" class="block mb-2 font-medium">น้ำหนัก (กก.)</label>
                        <input type="number" id="admin_weight" name="weight" class="w-full p-3 rounded-lg form-input" step="0.1">
                    </div>
                    <div>
                        <label for="admin_height" class="block mb-2 font-medium">ส่วนสูง (ซม.)</label>
                        <input type="number" id="admin_height" name="height" class="w-full p-3 rounded-lg form-input">
                    </div>
                    <div>
                        <label for="admin_village" class="block mb-2 font-medium">หมู่บ้าน</label>
                        <input type="text" id="admin_village" name="village" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                         <label for="admin_subdistrict" class="block mb-2 font-medium">ตำบล</label>
                        <input type="text" id="admin_subdistrict" name="subdistrict" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div>
                        <label for="admin_district" class="block mb-2 font-medium">อำเภอ</label>
                        <input type="text" id="admin_district" name="district" class="w-full p-3 rounded-lg form-input" required>
                    </div>
                    <div class="lg:col-span-3">
                        <label for="admin_photo" class="block mb-2 font-medium">ลิงก์รูปภาพ</label>
                        <input type="url" id="admin_photo" name="photo" class="w-full p-3 rounded-lg form-input" placeholder="https://example.com/image.jpg">
                    </div>
                </div>
                <div class="mt-8 flex justify-center">
                    <button type="submit" class="btn-action bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-full text-lg">บันทึกการแก้ไข</button>
                </div>
            </form>
        </div>
    </template>

    <template id="studentDetailModalTemplate">
        <div class="card w-full max-w-2xl mx-auto my-auto p-6 md:p-8 rounded-2xl relative">
            <button id="closeStudentDetailModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>
            <div class="flex flex-col md:flex-row items-center gap-6">
                <div class="flex-shrink-0">
                    <img id="detail-photo" src="" alt="รูปถ่ายนักเรียน" class="detail-photo">
                </div>
                <div class="text-left w-full">
                    <h3 id="detail-name" class="text-2xl font-bold text-purple-800"></h3>
                    <p class="text-md text-gray-600 mb-2" id="detail-nickname"></p>
                    <div class="space-y-1 text-gray-700">
                        <p><strong>เลขประจำตัว:</strong> <span id="detail-id"></span></p>
                        <p><strong>ชั้น:</strong> <span id="detail-class"></span></p>
                        <p><strong>ที่อยู่:</strong> <span id="detail-address"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="adminPanelTemplate">
        <h3 class="text-2xl font-semibold text-center text-purple-800 mb-4">ส่วนจัดการข้อมูล (Admin)</h3>
        <div class="card p-4 md:p-6 rounded-2xl mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <label for="classFilter">กรองตามห้องเรียน:</label>
                <select id="classFilter" class="form-select rounded-lg"><option value="all">แสดงทั้งหมด</option></select>
            </div>
            <form id="passwordChangeForm" class="flex flex-col md:flex-row items-center gap-2">
                <input type="password" id="currentPassword" maxlength="50" placeholder="รหัสผ่านปัจจุบัน" class="form-input rounded-lg p-2 text-sm" required>
                <input type="password" id="newPassword" maxlength="50" placeholder="รหัสผ่านใหม่" class="form-input rounded-lg p-2 text-sm" required>
                <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition">เปลี่ยนรหัสผ่าน</button>
            </form>
        </div>
        <div class="card p-4 md:p-6 rounded-2xl shadow-lg overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th class="px-2 py-3">รูปถ่าย</th>
                        <th class="px-4 py-3">เลขประจำตัว</th><th class="px-4 py-3">ชื่อ-สกุล</th><th class="px-4 py-3">ชั้น</th><th class="px-4 py-3">หมู่บ้าน</th>
                        <th class="px-4 py-3">ดำเนินการ</th>
                    </tr>
                </thead>
                <tbody id="student-table-body"></tbody>
            </table>
        </div>
    </template>


    <script>
        // --- CONFIGURATION ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxhNu_BiWEVJ-he_nBpQgM1KOYfNHiwFeca9MVqFnpKGjyWibOSwtBq2vvORG49-vhVag/exec';
        let adminPassword = localStorage.getItem('adminPassword_nadun_school') || 'admin';

        // --- STATE ---
        let allStudentsData = [];
        let allClassInfo = {};
        let headerMap = {};

        // --- DOM ELEMENTS ---
        const formModal = document.getElementById('formModal');
        const adminModal = document.getElementById('adminModal');
        const adminEditModal = document.getElementById('adminEditModal');
        const studentDetailModal = document.getElementById('studentDetailModal');
        const adminSection = document.getElementById('admin-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const statusDashboardSection = document.getElementById('status-dashboard-section');
        const dashboardTableContainer = document.getElementById('dashboard-table-container');

        // --- UTILITY & MAIN LOGIC ---
        function jsonpRequest(url, callbackName) {
            const uniqueCallbackName = `${callbackName}_${Date.now()}`;
            window[uniqueCallbackName] = (response) => {
                if (document.body.contains(script)) {
                    document.body.removeChild(script);
                }
                delete window[uniqueCallbackName];
                window._jsonp_callback_handler(response);
            };
            const script = document.createElement('script');
            script.src = `${url}&callback=${uniqueCallbackName}`;
            script.onerror = () => {
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้', 'error');
                if(document.body.contains(script)) document.body.removeChild(script);
                delete window[uniqueCallbackName];
            };
            document.body.appendChild(script);
        }

        window._jsonp_callback_handler = function(response) {
            Swal.close();
            const source = response.source;
            if (source === 'getAllData') handleAdminData(response);
            else if (source === 'checkId' || source === 'getDataByRow') handleGetDataResponse(response);
            else if (source === 'delete') handleDeleteResponse(response);
            else handleFormResponse(response);
        };
        
        // --- RESPONSE HANDLERS (Full definitions) ---
        function handleFormResponse(response) {
            if (response.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: response.source === 'update' ? 'แก้ไขข้อมูลสำเร็จ!' : 'บันทึกข้อมูลสำเร็จ!',
                    timer: 2000,
                    showConfirmButton: false
                });
                if (formModal.style.display === 'block') hideFormModal();
                if (adminEditModal.style.display === 'block') hideAdminEditModal();
                initializeDashboard();
                if (adminSection.style.display !== 'none') fetchAndDisplayAllData();
            } else {
                Swal.fire('เกิดข้อผิดพลาด', response.message || 'การดำเนินการล้มเหลว', 'error');
            }
        }

        function handleGetDataResponse(response) {
            if (response.found) {
                if (response.source === 'checkId') {
                     Swal.fire('พบข้อมูลซ้ำ', `มีนักเรียนเลขประจำตัวนี้ในระบบแล้ว หากต้องการแก้ไข กรุณาเข้าระบบ Admin`, 'warning');
                } else { // From admin edit click (getDataByRow)
                    showAdminEditModal(); // Must show first to create elements
                    populateAdminEditForm(response.data);
                }
            } else if (response.status === 'error'){
                 Swal.fire('เกิดข้อผิดพลาด', response.message, 'error');
            }
        }

        function handleAdminData(response) {
            if (response.status === 'success') {
                allStudentsData = response.data.students || [];
                allClassInfo = response.data.classInfo || {};
                
                if (allStudentsData.length > 0) {
                    const headers = allStudentsData[0];
                    headerMap = {}; // Reset map
                    headers.forEach((h, i) => { headerMap[h] = i; });
                }

                if (response.context === 'dashboard') {
                    updateDashboard();
                    updateStatusDashboard();
                } else if (response.context === 'adminPanel') {
                    adminSection.style.display = 'block';
                    adminSection.innerHTML = document.getElementById('adminPanelTemplate').innerHTML;
                    
                    document.getElementById('classFilter').addEventListener('change', (e) => populateAdminTable(e.target.value));
                    document.getElementById('passwordChangeForm').addEventListener('submit', handlePasswordChange);
                    
                    populateClassFilter();
                    populateAdminTable();
                }
            } else {
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถดึงข้อมูล Admin ได้', 'error');
            }
        }
        
        function handleDeleteResponse(response) {
            if (response.status === 'success') {
                Swal.fire('สำเร็จ!', 'ลบข้อมูลเรียบร้อยแล้ว', 'success');
                if (adminSection.style.display !== 'none') {
                    fetchAndDisplayAllData();
                }
                initializeDashboard();
            } else {
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถลบข้อมูลได้', 'error');
            }
        }
        
        // --- DASHBOARD & ADMIN ---
        function initializeDashboard() {
            dashboardSection.innerHTML = document.getElementById('dashboardTemplate').innerHTML;
            dashboardSection.style.display = 'block';
            statusDashboardSection.style.display = 'none'; // Hide initially
            dashboardTableContainer.style.display = 'none';
            adminSection.style.display = 'none';
            Swal.fire({ title: 'กำลังโหลดข้อมูล Dashboard...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            jsonpRequest(`${GAS_URL}?action=getAllData&context=dashboard`, 'dashboardCallback');
        }

        function fetchAndDisplayAllData() {
            dashboardSection.style.display = 'none';
            statusDashboardSection.style.display = 'none';
            dashboardTableContainer.style.display = 'none';
            Swal.fire({ title: 'กำลังโหลดข้อมูล Admin...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            jsonpRequest(`${GAS_URL}?action=getAllData&context=adminPanel`, 'adminCallback');
        }

        function updateDashboard() {
            const counts = { m1:0, m2:0, m3:0, m4:0, m5:0, m6:0, male:0, female:0, junior:0, senior:0 };
            if (!allStudentsData || allStudentsData.length < 2) { // Display 0 if no data
                Object.keys(counts).forEach(key => {
                    const elId = `${key.replace(/_/g, '-')}-count`;
                    const el = document.getElementById(elId);
                    if(el) el.textContent = 0;
                });
                return;
            };
            const data = allStudentsData.slice(1);
            
            data.forEach(row => {
                const studentClass = row[headerMap['class']]; 
                const gender = row[headerMap['gender']];
                if (gender === 'ชาย') counts.male++; 
                if (gender === 'หญิง') counts.female++;
                if (studentClass) {
                    if (studentClass.startsWith('ม.1')) { counts.m1++; counts.junior++; }
                    else if (studentClass.startsWith('ม.2')) { counts.m2++; counts.junior++; }
                    else if (studentClass.startsWith('ม.3')) { counts.m3++; counts.junior++; }
                    else if (studentClass.startsWith('ม.4')) { counts.m4++; counts.senior++; }
                    else if (studentClass.startsWith('ม.5')) { counts.m5++; counts.senior++; }
                    else if (studentClass.startsWith('ม.6')) { counts.m6++; counts.senior++; }
                }
            });
            Object.keys(counts).forEach(key => {
                const elId = `${key.replace(/_/g, '-')}-count`;
                const el = document.getElementById(elId);
                if(el) el.textContent = counts[key];
            });
        }

        function updateStatusDashboard() {
            if (Object.keys(allClassInfo).length === 0) {
                statusDashboardSection.style.display = 'none';
                return;
            }

            let contentHTML = '<h3 class="text-xl font-semibold text-center text-purple-800 mb-6">สถานะการบันทึกข้อมูล (รายห้อง)</h3>';
            contentHTML += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6">';

            const sortedClasses = Object.keys(allClassInfo).sort((a,b) => a.localeCompare(b, 'th-TH-u-nu-thai'));

            for (const className of sortedClasses) {
                const info = allClassInfo[className];
                const { target_male, target_female, actual_male, actual_female } = info;

                const percent_male = target_male > 0 ? Math.min(100, (actual_male / target_male) * 100) : 0;
                const percent_female = target_female > 0 ? Math.min(100, (actual_female / target_female) * 100) : 0;
                const total_target = target_male + target_female;
                const total_actual = actual_male + actual_female;
                const total_percent = total_target > 0 ? Math.min(100, (total_actual / total_target) * 100) : 0;

                contentHTML += `
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-purple-800">${className}</span>
                            <span class="text-sm font-bold text-gray-700">${total_actual}/${total_target} (${total_percent.toFixed(1)}%)</span>
                        </div>
                        <div class="mt-2">
                            <div class="text-sm flex justify-between">
                                <span>ชาย</span>
                                <span>${actual_male}/${target_male}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${percent_male}%"></div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <div class="text-sm flex justify-between">
                                <span>หญิง</span>
                                <span>${actual_female}/${target_female}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-pink-500 h-2.5 rounded-full" style="width: ${percent_female}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            contentHTML += '</div>';
            statusDashboardSection.innerHTML = contentHTML;
            statusDashboardSection.style.display = 'block';
        }

        function filterAndShowDashboardTable(type, value) {
            if (!allStudentsData || allStudentsData.length < 2) return;
            const data = allStudentsData.slice(1);
            let filteredData = [];

            if (type === 'gender') {
                filteredData = data.filter(row => row[headerMap['gender']] === value);
            } else if (type === 'level') {
                const juniorClasses = ['ม.1', 'ม.2', 'ม.3'];
                const seniorClasses = ['ม.4', 'ม.5', 'ม.6'];
                const targetClasses = value === 'junior' ? juniorClasses : seniorClasses;
                filteredData = data.filter(row => row[headerMap['class']] && targetClasses.some(c => row[headerMap['class']].startsWith(c)));
            } else if (type === 'class') {
                filteredData = data.filter(row => row[headerMap['class']] && row[headerMap['class']].startsWith(value));
            }
            
            let tableHTML = `
                <div class="card p-4 rounded-2xl overflow-x-auto">
                <h4 class="text-lg font-semibold text-center text-purple-700 mb-4">รายชื่อนักเรียน</h4>
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-4 py-3">เลขประจำตัว</th>
                            <th class="px-4 py-3">ชื่อ</th>
                            <th class="px-4 py-3">สกุล</th>
                            <th class="px-4 py-3">ชื่อเล่น</th>
                            <th class="px-4 py-3">ชั้น</th>
                        </tr>
                    </thead>
                    <tbody>`;

            if (filteredData.length === 0) {
                tableHTML += `<tr><td colspan="5" class="text-center p-4">ไม่พบข้อมูล</td></tr>`;
            } else {
                filteredData.forEach(row => {
                    const studentId = row[headerMap['student_id']];
                    tableHTML += `
                        <tr class="bg-white border-b hover:bg-gray-100 cursor-pointer" data-student-id="${studentId}">
                            <td class="px-4 py-2">${studentId}</td>
                            <td class="px-4 py-2">${row[headerMap['firstname']] || ''}</td>
                            <td class="px-4 py-2">${row[headerMap['lastname']] || ''}</td>
                            <td class="px-4 py-2">${row[headerMap['nickname']] || ''}</td>
                            <td class="px-4 py-2">${row[headerMap['class']] || ''}</td>
                        </tr>`;
                });
            }
            
            tableHTML += `</tbody></table></div>`;
            dashboardTableContainer.innerHTML = tableHTML;
            dashboardTableContainer.style.display = 'block';
        }

        function showStudentDetail(studentId) {
            const studentRow = allStudentsData.find(row => row[headerMap['student_id']] == studentId);
            if (!studentRow) return;

            studentDetailModal.innerHTML = document.getElementById('studentDetailModalTemplate').innerHTML;
            
            const student = {};
            allStudentsData[0].forEach((header, index) => {
                student[header] = studentRow[index];
            });

            document.getElementById('detail-photo').src = student.photo || 'https://placehold.co/150x150/e2e8f0/e2e8f0?text=No+Image';
            document.getElementById('detail-name').textContent = `${student.prefix || ''}${student.firstname || ''} ${student.lastname || ''}`;
            document.getElementById('detail-nickname').textContent = `ชื่อเล่น: ${student.nickname || '-'}`;
            document.getElementById('detail-id').textContent = student.student_id;
            document.getElementById('detail-class').textContent = student.class || '-';
            document.getElementById('detail-address').textContent = `บ้าน${student.village || '-'} ต.${student.subdistrict || '-'} อ.${student.district || '-'}`;
            
            studentDetailModal.style.display = 'block';
        }
        
        function populateAdminEditForm(data) {
             const form = document.getElementById('adminEditForm');
             if(!form) return;
             form.row.value = data.row;
             form.student_id.value = data.student_id || '';
             form.prefix.value = data.prefix || '';
             form.firstname.value = data.firstname || '';
             form.lastname.value = data.lastname || '';
             form.nickname.value = data.nickname || '';
             form.class.value = data.class || '';
             if(data.gender && form.querySelector(`input[name="gender"][value="${data.gender}"]`)) {
                form.querySelector(`input[name="gender"][value="${data.gender}"]`).checked = true;
             }
             form.weight.value = data.weight || '';
             form.height.value = data.height || data.hight || '';
             form.village.value = data.village || '';
             form.subdistrict.value = data.subdistrict || '';
             form.district.value = data.district || '';
             form.photo.value = data.photo || '';
        }

        function populateAdminTable(filter = 'all') {
            const studentTableBody = document.getElementById('student-table-body');
            if(!studentTableBody) return;
            studentTableBody.innerHTML = '';
            if (!allStudentsData || allStudentsData.length < 2) {
                 studentTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">ไม่พบข้อมูล</td></tr>`; return;
            }
            const studentData = allStudentsData.slice(1);
            const filteredData = (filter === 'all' || !filter) ? studentData : studentData.filter(row => row[headerMap['class']] && row[headerMap['class']] === filter);
            
            filteredData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-gray-50';
                const originalRowIndex = allStudentsData.findIndex(r => r[headerMap['student_id']] === row[headerMap['student_id']]);
                const sheetRowNumber = originalRowIndex + 1; // +1 because data is sliced, +1 for 1-based index
                const student_id = row[headerMap['student_id']] || '';
                const photoUrl = row[headerMap['photo']] || '';
                
                tr.innerHTML = `
                    <td class="p-2 text-center"><img src="${photoUrl || 'https://placehold.co/100x100/e2e8f0/e2e8f0?text=.'}" alt="รูปนักเรียน" class="photo-thumbnail mx-auto"></td>
                    <td class="px-4 py-2 font-medium text-gray-900">${student_id}</td>
                    <td class="px-4 py-2">${(row[headerMap['prefix']] || '')} ${(row[headerMap['firstname']] || '')} ${row[headerMap['lastname']] || ''}</td>
                    <td class="px-4 py-2">${row[headerMap['class']] || ''}</td>
                    <td class="px-4 py-2">${row[headerMap['village']] || ''}</td>
                    <td class="px-4 py-2 flex gap-2">
                        <button onclick="window.handleEditClick('${sheetRowNumber}')" class="font-medium text-blue-600 hover:underline">แก้ไข</button>
                        <button onclick="window.handleDeleteClick('${sheetRowNumber}', '${student_id}')" class="font-medium text-red-600 hover:underline">ลบ</button>
                    </td>`;
                studentTableBody.appendChild(tr);
            });
        }
        
        function populateClassFilter() {
            const classFilterEl = document.getElementById('classFilter');
            if (!classFilterEl) return;
            const classes = new Set(allStudentsData.slice(1).map(row => row[headerMap['class']]).filter(Boolean));
            classFilterEl.innerHTML = '<option value="all">แสดงทั้งหมด</option>';
            Array.from(classes).sort((a,b) => a.localeCompare(b, 'th-TH-u-nu-thai')).forEach(c => {
                const option = document.createElement('option');
                option.value = c; option.textContent = c;
                classFilterEl.appendChild(option);
            });
        }
        
        window.handleEditClick = (rowNumber) => {
            Swal.fire({title: 'กำลังโหลดข้อมูลเพื่อแก้ไข...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
            jsonpRequest(`${GAS_URL}?action=getDataByRow&row=${rowNumber}`, 'editCallback');
        };
        
        window.handleDeleteClick = (rowNumber, studentId) => {
            Swal.fire({
                title: `คุณแน่ใจหรือไม่?`, text: `ต้องการลบข้อมูลนักเรียนเลขประจำตัว ${studentId}?`, icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'กำลังลบข้อมูล...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    jsonpRequest(`${GAS_URL}?action=delete&row=${rowNumber}`, 'deleteCallback');
                }
            });
        };
        
        function handlePasswordChange(e) {
            e.preventDefault();
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            if (currentPass !== adminPassword) {
                Swal.fire('เกิดข้อผิดพลาด', 'รหัสผ่านปัจจุบันไม่ถูกต้อง', 'error'); return;
            }
            if (!newPass || newPass.length < 4) {
                Swal.fire('เกิดข้อผิดพลาด', 'รหัสผ่านใหม่ต้องมีอย่างน้อย 4 ตัวอักษร', 'error'); return;
            }
            localStorage.setItem('adminPassword_nadun_school', newPass);
            adminPassword = newPass;
            Swal.fire('สำเร็จ', 'เปลี่ยนรหัสผ่านเรียบร้อยแล้ว!', 'success');
            e.target.reset();
        }
        
        function showFormModal() { 
            formModal.innerHTML = document.getElementById('formModalTemplate').innerHTML;
            populateDropdowns(formModal);
            formModal.style.display = 'block'; 
        }
        function hideFormModal() { 
            formModal.style.display = 'none'; 
            formModal.innerHTML = '';
        }
        function showAdminModal() { 
            adminModal.innerHTML = document.getElementById('adminModalTemplate').innerHTML;
            adminModal.style.display = 'block'; 
        }
        function hideAdminModal() { 
            adminModal.style.display = 'none';
            adminModal.innerHTML = ''; 
        }
        function showAdminEditModal() { 
            adminEditModal.innerHTML = document.getElementById('adminEditModalTemplate').innerHTML;
            populateDropdowns(adminEditModal);
            adminEditModal.style.display = 'block'; 
        }
        function hideAdminEditModal() { 
            adminEditModal.style.display = 'none'; 
            adminEditModal.innerHTML = '';
        }

        function populateDropdowns(modalElement) {
            const allClassSelects = modalElement.querySelectorAll('select[name="class"]');
            const allPrefixSelects = modalElement.querySelectorAll('select[name="prefix"]');
            const levels = { 'ม.1': 6, 'ม.2': 6, 'ม.3': 5, 'ม.4': 4, 'ม.5': 4, 'ม.6': 4 };
            const prefixes = ['เด็กชาย', 'เด็กหญิง', 'นาย', 'นางสาว'];

            allClassSelects.forEach(select => {
                select.innerHTML = ''; // Clear existing
                 for (const level in levels) for (let i = 1; i <= levels[level]; i++) select.add(new Option(`${level}/${i}`, `${level}/${i}`));
            });
            allPrefixSelects.forEach(select => {
                select.innerHTML = ''; // Clear existing
                prefixes.forEach(p => select.add(new Option(p,p)));
            });
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Main buttons
            document.getElementById('showFormButton').addEventListener('click', showFormModal);
            document.getElementById('adminButton').addEventListener('click', showAdminModal);

            // Event delegation for dynamically added content
            document.body.addEventListener('click', (e) => {
                // Modals close buttons
                if(e.target.closest('#closeFormModal')) hideFormModal();
                if(e.target.closest('#closeAdminModal')) hideAdminModal();
                if (e.target.closest('#closeAdminEditModal')) hideAdminEditModal();
                if (e.target.closest('#closeStudentDetailModal')) studentDetailModal.style.display = 'none';

                // Form clear button
                if(e.target.id === 'clearButton') document.getElementById('studentForm')?.reset();
                
                // Admin password submit
                if(e.target.id === 'submitPassword') {
                    const input = document.getElementById('adminPasswordInput');
                    if(input && input.value === adminPassword) {
                        hideAdminModal(); input.value = '';
                        fetchAndDisplayAllData();
                    } else if (input) {
                        Swal.fire('รหัสผ่านไม่ถูกต้อง', '', 'error');
                    }
                }

                 // Dashboard clicks
                const card = e.target.closest('.stat-card');
                if (card) {
                    const filterType = card.dataset.filterType;
                    const filterValue = card.dataset.filterValue;
                    if (filterType && filterValue) filterAndShowDashboardTable(filterType, filterValue);
                }

                // Dashboard table row clicks
                const row = e.target.closest('tr[data-student-id]');
                if (row) showStudentDetail(row.dataset.studentId);
            });

            document.body.addEventListener('submit', (e) => {
                // Student form
                if(e.target.id === 'studentForm') {
                    e.preventDefault();
                    Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());
                    let params = new URLSearchParams(data);
                    params.append('action', 'add');
                    jsonpRequest(`${GAS_URL}?${params.toString()}`, 'formCallback');
                }
                // Admin edit form
                if (e.target.id === 'adminEditForm') {
                    e.preventDefault();
                    Swal.fire({ title: 'กำลังบันทึกการแก้ไข...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());
                    let params = new URLSearchParams(data);
                    params.append('action', 'update');
                    jsonpRequest(`${GAS_URL}?${params.toString()}`, 'formCallback');
                }
            });

            document.body.addEventListener('blur', (e) => {
                if(e.target.id === 'student_id' && e.target.value) {
                     jsonpRequest(`${GAS_URL}?action=checkId&id=${e.target.value}`, 'checkIdCallback');
                }
            }, true); // Use capture phase for blur

            initializeDashboard();
        });
    </script>
</body>
</html>